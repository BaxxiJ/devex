= The Container Registry and Deploying applications
:navtitle: The Container Registry and Deploying applications
:source-highlighter: rouge

image::11-00-image-registry.png[Container Image Journey,600,align="center"]

== The Container Registry and Deploying applications

====
*What will you learn?*

This module will introduce you to the concepts of the image registry within the OpenShift platform and how to use it.

This module will also cover external 'enterprise' image registries such as Red Hat Quay and quay.io.

After completing the module you will understand how the image registry is used within the OpenShift platform. You will also know how to use images from the OpenShift registry.
====

=== *Pre-Requisites*

In order to undertake the module you need to be logged onto the cluster and have access to a project. The project will have been created in a prior exercise. The application to which the environment variables will be added will also have been created in a prior exercise.

Ensure that the two text boxes at the top of page contain the Cluster address provided by the workshop facilitators and the project you have been assigned. Remember to press *RETURN* after entering text into each field.

== Introducing the OpenShift Image Registry

The purpose of the image registry is to store container images for use on the OpenShift cluster. Such images may be created by a build process directly on the cluster, or the images may be pulled from other registries to be used immediately or for later use on the cluster.

=== Terms

A number of terms are used when describing the image registry within OpenShift.

* *Registry* is used to describe an instance of something that can hold multiple container images in different repositories. As you will soon see the notion of a 'registry' in OpenShift is actually split across a number of repositories.

* *Enterprise Registry* is used to refer to a registry that exists within a third party solution purely for the purpose of storing, cataloguing and serving images.

* *Image Repository* is a collection of related images that have the same name but have different tags to denote specific versions of the container image.

* *Image Stream* is an entity that exists within a namespace of an OpenShift cluster for the storage of one or more container images. Generally a separate imagestream is used for each specific image. As the software evolves and new container images are built, new tagged images appear within the imagestream. The OpenShift image registry is a collection of multiple image streams across multiple namespaces. Since image streams contain a collection of related images with the same image name, but different tags, the image stream is analogous to the image repository.

* *Image Tag* is a unique identifier for a version of an image within the image stream or within an enterprise registry.

==== Image registry, repository and tag related to quay.io

If you take a look in quay.io/marrober you are looking at an enterprise registry. Within this registry you will see multiple repositories such as quay.io/marrober/liberty-rest. When you look inside the repository liberty-rest at the url shown below, you will see multiple tags.

[.console-output]
[source,bash]
----
https://quay.io/repository/marrober/liberty-rest?tab=tags
----

So the relationship is : <registry>/<repository>:<tag>

=== Container image creation and management

Container images are created as a result of a build process running on the OpenShift container platform. The build process is responsible for the compilation, or packaging, of source code and the delivering of the executable package to the base container image. This creates a new container image ready to run your application. The image is stored in an image stream within a namespace from where it is deployed to be executed on the container platform. This process is shown below. If you have successfully completed the prior sections of the workshop then you will have a number of container images in image streams already.

image::11-01-container-image-journey.png[Container Image Journey,800,align="center"]

If the testing activity is successful, and the team wishes to share the container image wide, then the container image may then be pushed to an enterprise registry, with a new name and tag. From the enterprise registry it may be pulled by other clusters to deploy the container image to (for example) quality assurance clusters and ultimately a production cluster. This process is shown below.

image::11-02-container-image-journey-enterprise.png[Container Image Journey - to production,800,align="center"]

== Viewing the container registry

The container registry can be viewed and modified usng the OpenShift graphical user interface and via the command line interface. both will be used here to interact with the container registry.

=== Graphical interface interaction with container registry

On the OpenShift web user interface select the developer perspective on the top left of the screen and then select the topology view. This will show a number of deployments depending on how many you chose to create in the section on extending your application.

image::11-03-developer-topology-view.png[Developer topology view,800,align="center"]

The menu on the left hand side of the screen shows a number of developer centric operations such as viewing a build configuration to execute a build. There are also options to view config maps and secrets too. These are typical things that developers will do. The menu items we need for the image registry are actually on the administrator menu. While your role may not fit that description exactly, there are some tasks that you need to do that are described in this way. Switch the perspective to the administrator perspective using the option on the top left of the screen by clicking on the word 'Developer'.

The administrator perspective is shown below. The project that you can see will depend on your user number. User3 is shown in the screen images here, for example.

image::11-04-administrator-view.png[Administrator view,800,align="center"]

From the administrator perspective shown above select the Build menu on the right hand side and then select the ImageStreams sub menu. The result will appear similar the image below depending on how many applications have been added to the topology. There will be one imagestream for each deployment.

image::11-05-image-streams.png[Image streams (gui),800,align="center"]








=== Command line interaction with container registry

The 'oc' command has been used for a number of operations so far to examine resources created within the cluster. This can also be used for viewing and manipulating image streams. To view an the image streams that exist within a namespace use the command below :

[.console-input]
[source,bash,subs="+attributes"]
----
oc get imagestream
----

The above command can be abreviated to save typing to simply:

[.console-input]
[source,bash,subs="+attributes"]
----
oc get is
----

The result of the above command will be similar to that which is shown below:

[source,bash,subs="+attributes"]
----
NAME              IMAGE REPOSITORY                                                                TAGS   UPDATED
{app-1}   default-route-openshift-image-registry.%CLUSTER_SUBDOMAIN%/%PROJECT%/{app-1}
{app-1}   default-route-openshift-image-registry.%CLUSTER_SUBDOMAIN%/%PROJECT%/{app-2}
----

In a similar manner to other commands used previously the 'oc get' command can be used to get detailed information about the resource in either yaml or json format usng the -o yaml and -o json arguments respectively. Use the command below to get details of one of the image streams paying particular attention to the 'app.openshift.io/vcs-uri' metadata which shows the version control repository URL that was used to create the image within the image stream.

[.console-input]
[source,bash,subs="+attributes"]
----
oc get imagestream/{app-1} -o json
----

***** Get image tags with command line

== Using Podman to interact with a container image

Podman is an open source project that can be used to interact with container images. The podman command contains a number of sub commands for the creation, management and local execution of container images. In order for anyone to interact with container images stored within the OpenShift image streams the OpenShift image registry must be made visible on an external route. This is an administrator task and you can see if you can use the images from Podman by trying to login to the registry from the Podman command line using the command shown below :

[.console-input]
[source,bash,subs="+attributes"]
----
podman login -u $(oc whoami) -p $(oc whoami -t) --tls-verify=false default-route-openshift-image-registry.%CLUSTER_SUBDOMAIN%
----

The above command is interesting because it uses your user id, taken from the command 'oc whoami' and it also uses a generated token to authenticate you from the command 'oc whoami -t'. try out 'oc whoami -t' on the command line alone if you want to see what the token looks like.

Now that you are authenticated to the OpenShift registry you can interact with the container images.
